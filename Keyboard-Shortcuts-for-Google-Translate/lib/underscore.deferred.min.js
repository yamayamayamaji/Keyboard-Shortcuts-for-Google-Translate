/**
 * underscore.deferred.js (Underscore mixin)
 * https://github.com/wookiehangover/underscore.Deferred
 *
 * Copyright (c) 2012 Sam Breed
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
(function(n){var s={},o=Array.prototype,t=Object.prototype,A=t.hasOwnProperty,B=t.toString,u=o.forEach,v=o.indexOf,p=o.slice,k=function(a,b,d){var c,g;if(a)if(u&&a.forEach===u)a.forEach(b,d);else if(a.length===+a.length){c=0;for(g=a.length;c<g&&!(c in a&&b.call(d,a[c],c,a)===s);c++);}else for(c in a)if(A.call(a,c)&&b.call(d,a[c],c,a)===s)break},m=function(a){return!(!a||!a.constructor||!a.call||!a.apply)},w=function(a){k(p.call(arguments,1),function(b){for(var d in b)void 0!==b[d]&&(a[d]=b[d])});
return a},x=function(a,b,d){var c;if(b){if(v)return v.call(b,a,d);c=b.length;for(d=d?0>d?Math.max(0,c+d):d:0;d<c;d++)if(d in b&&b[d]===a)return d}return-1},y={};k("Boolean Number String Function Array Date RegExp Object".split(" "),function(a){y["[object "+a+"]"]=a.toLowerCase()});var f={},z={};f.Callbacks=function(a){var b;if("string"===typeof a){if(!(b=z[a])){b=a;var d=z[b]={};k(b.split(/\s+/),function(a){d[a]=!0});b=d}}else b=w({},a);var a=b,c,g,j,q,h,i,e=[],l=!a.once&&[],r=function(b){c=a.memory&&
b;g=!0;i=q||0;q=0;h=e.length;for(j=!0;e&&i<h;i++)if(!1===e[i].apply(b[0],b[1])&&a.stopOnFalse){c=!1;break}j=!1;e&&(l?l.length&&r(l.shift()):c?e=[]:f.disable())},f={add:function(){if(e){var b=e.length;(function C(b){k(b,function(b){var c=null==b?String(b):y[B.call(b)]||"object";"function"===c&&(!a.unique||!f.has(b))?e.push(b):b&&(b.length&&"string"!==c)&&C(b)})})(arguments);j?h=e.length:c&&(q=b,r(c))}return this},remove:function(){e&&k(arguments,function(b){for(var a;-1<(a=x(b,e,a));)e.splice(a,1),
j&&(a<=h&&h--,a<=i&&i--)});return this},has:function(b){return-1<x(b,e)},empty:function(){e=[];return this},disable:function(){e=l=c=void 0;return this},disabled:function(){return!e},lock:function(){l=void 0;c||f.disable();return this},locked:function(){return!l},fireWith:function(b,a){a=a||[];a=[b,a.slice?a.slice():a];if(e&&(!g||l))j?l.push(a):r(a);return this},fire:function(){f.fireWith(this,arguments);return this},fired:function(){return!!g}};return f};f.Deferred=function(a){var b=[["resolve",
"done",f.Callbacks("once memory"),"resolved"],["reject","fail",f.Callbacks("once memory"),"rejected"],["notify","progress",f.Callbacks("memory")]],d="pending",c={state:function(){return d},always:function(){g.done(arguments).fail(arguments);return this},then:function(){var a=arguments;return f.Deferred(function(c){k(b,function(b,d){var e=b[0],f=a[d];g[b[1]](m(f)?function(){var a=f.apply(this,arguments);if(a&&m(a.promise))a.promise().done(c.resolve).fail(c.reject).progress(c.notify);else c[e+"With"](this===
g?c:this,[a])}:c[e])});a=null}).promise()},promise:function(a){return"object"===typeof a?w(a,c):c}},g={};c.pipe=c.then;k(b,function(a,f){var h=a[2],i=a[3];c[a[1]]=h.add;i&&h.add(function(){d=i},b[f^1][2].disable,b[2][2].lock);g[a[0]]=h.fire;g[a[0]+"With"]=h.fireWith});c.promise(g);a&&a.call(g,g);return g};f.when=function(a){var b=0,d=p.call(arguments),c=d.length,g=1!==c||a&&m(a.promise)?c:0,j=1===g?a:f.Deferred(),k=function(a,b,c){return function(d){b[a]=this;c[a]=1<arguments.length?p.call(arguments):
d;c===h?j.notifyWith(b,c):--g||j.resolveWith(b,c)}},h,i,e;if(1<c){h=Array(c);i=Array(c);for(e=Array(c);b<c;b++)d[b]&&m(d[b].promise)?d[b].promise().done(k(b,e,d)).fail(j.reject).progress(k(b,i,h)):--g}g||j.resolveWith(e,d);return j.promise()};"undefined"!==typeof module&&module.exports?module.exports=f:"undefined"!==typeof n._?n._.mixin(f):n._=f})(this);